Absolutely! Here's a comprehensive **understanding document** that connects everything â€” from **Entities â†’ Repositories â†’ Services â†’ Controllers** â€” while explaining how **data flows**, what is **expected from the frontend**, and what **each layer does** in your cab booking system.

---

# ğŸ§  Cab Booking System: Understanding & Flow Document

## ğŸ¯ Overview

A real-time cab booking platform with two user roles:

* **User**: Books rides, pays, and rates the driver
* **Driver**: Accepts ride requests, completes rides, and sees ratings

---

## ğŸ§© 1. ENTITY LAYER (JPA Models)

| Entity    | Purpose                                                                |
| --------- | ---------------------------------------------------------------------- |
| `User`    | Stores user info (name, email, phone, password, role)                  |
| `Driver`  | Stores driver info (email, phone, vehicle, license, availability flag) |
| `Ride`    | Stores ride details (pickup, dropoff, status, fare, distance, etc.)    |
| `Payment` | Linked to `Ride`, stores amount, method, timestamp, status             |
| `Rating`  | Linked to `Ride`, stores score and comment                             |

**Enum types used:**

* `Role`: `USER`, `DRIVER`
* `RideStatus`: `REQUESTED`, `ACCEPTED`, `IN_PROGRESS`, `COMPLETED`
* `PaymentMethod`: `CASH`, `CARD`, etc.

---

## ğŸ§¾ 2. REPOSITORY LAYER

| Repository          | Core Methods Used                                                              |
| ------------------- | ------------------------------------------------------------------------------ |
| `UserRepository`    | `findByEmail()`                                                                |
| `DriverRepository`  | `findByEmail()`, `findByPhone()`, `findByAvailableTrue()`                      |
| `RideRepository`    | `findUnassignedRideRequests()`, `findByUserUserId()`, `findByDriverDriverId()` |
| `PaymentRepository` | `findByRideRideId()`                                                           |
| `RatingRepository`  | `findByDriverId()`, `existsByRide()`                                           |

These are injected into services for business logic.

---

## ğŸ”§ 3. SERVICE LAYER

Services contain **core business logic** and connect controllers to data access layer.

### A. `UserService`

* `register()`, `login()`, `getProfile(token)`
* `bookRide(token, rideRequest)`
* `getCurrentRide(token)`, `getRideHistory(token)`

â†’ Used in **UserController**
â†’ Expects frontend to:

* Register/login user
* Send pickup, drop, distance, duration, fare in `Ride` object during booking
* Use JWT token in `Authorization` header for requests

---

### B. `DriverService`

* `register()`, `login()`, `getProfile(token)`
* `updateAvailability(token, boolean)`
* `getAvailableRideRequests()`
* `acceptRide(token, rideId)`, `getCurrentRide(token)`
* `updateRideStatus(token, status)`
* `getRideHistory(token)`

â†’ Used in **DriverController**
â†’ Expects frontend to:

* Toggle availability
* Poll ride requests if available
* Accept ride via ride ID
* Update status (`IN_PROGRESS`, `COMPLETED`)

---

### C. `RideService`

* `getRideById(rideId)`
* `updateRideStatus(rideId, status)` â€” admin/debug
  â†’ Used in **RideController**

---

### D. `PaymentService`

* `processPayment(PaymentRequest)`
  â†’ Expects: `rideId`, `amount`, `method`
* `getReceipt(rideId)` â†’ Used after ride payment
  â†’ Used in **PaymentController**

---

### E. `RatingService`

* `submitRating(RatingRequest)`
  â†’ Expects: `rideId`, `score`, `comment`
* `getRatings(driverId)` â†’ Admin
* `getRatingsForDriver(token)` â†’ Driver dashboard
  â†’ Used in **RatingController**

---

## ğŸŒ 4. CONTROLLER LAYER

Handles HTTP requests/responses, calls appropriate service methods.

| Controller          | Purpose                                                                                   |
| ------------------- | ----------------------------------------------------------------------------------------- |
| `UserController`    | Register, login, get profile, book ride, view ride history                                |
| `DriverController`  | Register, login, toggle availability, accept/view rides, update status, view ride history |
| `RideController`    | Get ride by ID, manually update ride status                                               |
| `PaymentController` | Process ride payment, get receipt                                                         |
| `RatingController`  | Submit and view ratings                                                                   |

All endpoints expect `Authorization: Bearer <token>` for protected routes.

---

## ğŸ“¥ DATA EXPECTED FROM FRONTEND

### ğŸ” Auth

* Register/Login for user/driver returns **JWT**
* JWT stored in frontend and sent as header in all further requests

### ğŸš• Ride Booking (User)

* User sends:

```json
{
  "pickupLocation": "A",
  "dropoffLocation": "B",
  "distance": 4.2,
  "fare": 200
}
```

â†’ This data is generated on the frontend using **Leaflet.js** and sent to `/api/users/book`

### ğŸ“² Driver Flow

* Toggle availability (true/false)
* View ride requests â†’ `GET /api/drivers/rides/requests`
* Accept ride â†’ `POST /api/drivers/rides/accept?rideId=3`
* Update status â†’ `POST /api/drivers/rides/status?status=IN_PROGRESS` or `COMPLETED`

### ğŸ’³ Payment

* After ride completed, simulate payment via:

```json
{
  "rideId": 3,
  "amount": 200,
  "method": "CASH"
}
```

### â­ Rating

* After payment, user submits:

```json
{
  "rideId": 3,
  "score": 5,
  "comment": "Great ride!"
}
```

---

## ğŸ” DATA FLOW SUMMARY

```
Frontend â†’ Controller â†’ Service â†’ Repository â†’ Entity â†’ DB

â—‰ User books ride
â—‰ Available drivers get ride
â—‰ First driver to accept gets assigned
â—‰ Driver starts â†’ completes ride
â—‰ User pays â†’ rates driver
â—‰ All actions logged in DB
â—‰ Ride/payment/rating history visible to both roles
```

---

Would you like a **PDF version** of this understanding document or move on to designing the **frontend wireframes + flow** in React?
